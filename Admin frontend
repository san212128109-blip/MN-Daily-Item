<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin - MN Daily Items</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .admin-wrap { max-width:1000px; margin:20px auto; padding:20px; background:white; border-radius:8px;}
    .grid { display:flex; gap:12px; flex-wrap:wrap; }
    .admin-card { width:220px; padding:12px; border-radius:8px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
    .admin-card img { width:100%; height:140px; object-fit:cover; border-radius:6px; }
    form input, form textarea { width:100%; padding:8px; margin:6px 0; box-sizing:border-box; }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="logo">MN Daily Items — Admin</div>
    <div style="margin-left:auto"><button id="logoutBtn">Logout</button></div>
  </header>

  <div class="admin-wrap">
    <h2>Create New Product</h2>
    <form id="createForm" enctype="multipart/form-data">
      <input name="title" placeholder="Title" required />
      <textarea name="desc" placeholder="Description"></textarea>
      <input name="price" type="number" step="0.01" placeholder="Price" required />
      <input name="category" placeholder="Category" />
      <input name="image" type="file" accept="image/*" />
      <button type="submit">Create Product</button>
    </form>

    <hr/>

    <h2>All Products</h2>
    <div id="productsGrid" class="grid"></div>
  </div>

  <script>
    async function fetchProducts(){
      const res = await fetch('/api/admin/products');
      if(res.status === 401){ alert('Not authorized — login first'); location.href='/admin-login.html'; return; }
      const j = await res.json();
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      j.products.forEach(p => {
        const el = document.createElement('div');
        el.className = 'admin-card';
        el.innerHTML = `
          <img src="${p.image || '/uploads/default.png'}" alt="">
          <h3>${escape(p.title)}</h3>
          <p>${p.category} • $${Number(p.price).toFixed(2)}</p>
          <button onclick="showEdit('${p._id}')">Edit</button>
          <button onclick="del('${p._id}')">Delete</button>
        `;
        grid.appendChild(el);
      });
    }

    function escape(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    document.getElementById('createForm').addEventListener('submit', async e => {
      e.preventDefault();
      const form = e.target;
      const fd = new FormData(form);
      const res = await fetch('/api/admin/products', { method: 'POST', body: fd });
      const j = await res.json();
      if(j.error) alert(j.error); else { alert('Created'); form.reset(); fetchProducts(); }
    });

    async function del(id){
      if(!confirm('Delete product?')) return;
      const res = await fetch('/api/admin/products/' + id, { method: 'DELETE' });
      const j = await res.json();
      if(j.error) alert(j.error); else { alert('Deleted'); fetchProducts(); }
    }

    function showEdit(id){
      const url = '/product.html?id=' + id;
      // quick approach: open product page in new tab for manual edit — or implement modal edit here.
      window.open('/admin-edit.html?id=' + id, '_blank');
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/admin/logout', { method: 'POST' });
      location.href = '/';
    });

    // load on start
    fetchProducts();
  </script>
</body>
</html>
